<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.0/flowbite.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">User Profile</h2>

        <!-- User Profile Form -->
        <form id="profileForm" class="space-y-4">
            <div>
                <label class="block text-gray-700">Email</label>
                <input type="email" id="email" class="w-full px-3 py-2 border rounded-lg" value="<%= user?.email %>" disabled>
            </div>

            <div>
                <label class="block text-gray-700">Shop Name</label>
                <input type="text" id="shopName" class="w-full px-3 py-2 border rounded-lg" value="<%= user?.shopName || 'Not Available' %>" disabled>
            </div>

            <div>
                <label class="block text-gray-700">Phone Number</label>
                <input type="text" id="phone" class="w-full px-3 py-2 border rounded-lg" value="<%= user?.phone|| 'Not Available' %>" disabled>
            </div>

            <div>
                <label class="block text-gray-700">District</label>
                <input type="text" id="district" class="w-full px-3 py-2 border rounded-lg" value="<%= user?.district || 'Not Available' %>" disabled>
            </div>

            <div>
                <label class="block text-gray-700">Building/House Name</label>
                <input type="text" id="buildingName" class="w-full px-3 py-2 border rounded-lg" value="<%= user?.address?.buildingName || 'Not Available' %>" disabled>
            </div>

            <div>
                <label class="block text-gray-700">Street</label>
                <input type="text" id="street" class="w-full px-3 py-2 border rounded-lg" value="<%= user?.address?.street || 'Not Available' %>" disabled>
            </div>

            <div>
                <label class="block text-gray-700">Locality</label>
                <input type="text" id="locality" class="w-full px-3 py-2 border rounded-lg" value="<%= user?.address?.locality || 'Not Available' %>" disabled>
            </div>

            <div>
                <label class="block text-gray-700">Pincode</label>
                <input type="text" id="pincode" class="w-full px-3 py-2 border rounded-lg" value="<%= user?.address?.pincode || 'Not Available' %>" disabled>
            </div>

            <!-- Services Available Online -->
            <div>
                <label class="block text-gray-700">Services Available Online</label>
                <div class="flex flex-col mt-2">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="services" value="income_certificate" class="mr-2" <%= user?.services?.includes('income_certificate') ? 'checked' : '' %> disabled>
                        Income Certificate
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="services" value="voter_registration" class="mr-2" <%= user?.services?.includes('voters_id') ? 'checked' : '' %> disabled>
                        Voter Registration (Election ID Card)
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="services" value="passport_service" class="mr-2" <%= user?.services?.includes('passport_service') ? 'checked' : '' %> disabled>
                        Passport Service
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="services" value="utility_payments" class="mr-2" <%= user?.services?.includes('utility_payments') ? 'checked' : '' %> disabled>
                        Utility Payments (KSEB, BSNL, Water Bills)
                    </label>
                </div>
            </div>

            <!-- Edit & Save Buttons -->
            <div class="flex justify-between">
                <button type="button" id="editBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg">Edit</button>
                <button type="button" id="saveBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hidden">Save</button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const editBtn = document.getElementById("editBtn");
            const saveBtn = document.getElementById("saveBtn");
            const formFields = document.querySelectorAll("#profileForm input");

            editBtn.addEventListener("click", function () {
                formFields.forEach(field => field.removeAttribute("disabled"));
                editBtn.classList.add("hidden");
                saveBtn.classList.remove("hidden");
            });

            saveBtn.addEventListener("click", async function () {
                const selectedServices = Array.from(document.querySelectorAll("input[name='services']:checked")).map(cb => cb.value);

                const formData = {
                    email: document.getElementById("email").value,
                    shopName: document.getElementById("shopName").value,
                    phone: document.getElementById("phone").value,
                    district: document.getElementById("district").value,
                    address: {
                        buildingName: document.getElementById("buildingName").value,
                        street: document.getElementById("street").value,
                        locality: document.getElementById("locality").value,
                        pincode: document.getElementById("pincode").value
                    },
                    services: selectedServices
                };

                try {
                    const response = await fetch("/profile", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert(result.message);
                        formFields.forEach(field => field.setAttribute("disabled", "true"));
                        editBtn.classList.remove("hidden");
                        saveBtn.classList.add("hidden");
                    } else {
                        alert("Error: " + result.message);
                    }
                } catch (error) {
                    console.error("Error updating profile:", error);
                }
            });
        });
    </script>
</body>
</html>
